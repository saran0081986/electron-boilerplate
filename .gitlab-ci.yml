stages:
    - build
    - review
    - pack

.build: &build-job
    stage: build
    cache:
        paths:
            - node_modules/
            #- $HOME/.yarn-cache
    artifacts:
        name: "${CI_BUILD_REF_NAME}-${CI_BUILD_NAME}"
        paths:
            - build/
            #- yarn.lock
    before_script:
        #- npm install yarn
    script:
        - npm install
        #- ./node_modules/.bin/yarn
        - npm run build

build:node-6:
    image: node:6
    <<: *build-job

build:node-7:
    image: node:7
    allow_failure: true
    <<: *build-job

sonar:
    image: maxwellewxam/sonar-scanner
    stage: review
    only:
        - branches
    except:
        - dmz
    cache:
        paths:
            - .sonar/
    script: sonar-scanner -D sonar.host.url=http://sonar.flow.local:80 -D sonar.branch=$CI_BUILD_REF_NAME -D sonar.login=$SONAR_TOKEN

electron:
    image: node:6
    stage: pack
    only:
        - tags
    cache:
        paths:
            - tmp
            #- $HOME/.yarn-cache
    artifacts:
        name: "${CI_BUILD_REF_NAME}-${CI_BUILD_NAME}"
        paths:
            - packages/
    before_script:
        #- npm install yarn
        - npm install cross-env@"^3.1.3"
        - npm install electron-packager@"^8.4.0"
        - npm install yarn-install@"^0.2.1"
    script: npm run pack
