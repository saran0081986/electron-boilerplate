stages:
  - build
  - test
  - review
  - pack


####################
# BUILD
####################
.build: &build-job
  stage: build
  cache: # Used to transmit dependencies amongst jobs.
    key: npm
    paths:
      - node_modules/
      #- $HOME/.yarn-cache
  before_script:
    # Yarn is not used because it hangs during packages installation.
    #- npm -q install yarn
    #- ./node_modules/.bin/yarn
    #- npm -q update
  script: echo "lol"
    #- npm run build

# LTS NodeJS version.
build:node-6:
  image: node:6
  <<: *build-job
  artifacts: # Exports the build.
    name: "${CI_COMMIT_REF_NAME}-${CI_JOB_NAME}"
    paths:
      - build/
      #- yarn.lock
    expire_in: 1h

# Stable NodeJS version, optional.
build:node-7:
  image: node:7
  allow_failure: true
  <<: *build-job


####################
# TEST
####################
test:
  image: node:6
  stage: test
  cache: # Retrieves dependencies.
    key: npm
    paths:
      - node_modules/
  dependencies: []
  artifacts: # Exports coverage reports.
    name: "${CI_COMMIT_REF_NAME}-${CI_JOB_NAME}_coverage"
    paths:
      - coverage/
    expire_in: 1h
  before_script:
    # Cache is not effective, temporary solution,
    # see https://forum.gitlab.com/t/cache-not-working/5694.
    - npm -q update
    - apt-get update && apt-get install -y xvfb libgtk2.0-0
    - export DISPLAY=:99.0
  script: npm test

####################
# REVIEW
####################

# SonarQube
###########
.sonarqube: &sonarqube-job
  image: maxwellewxam/sonar-scanner
  stage: review
  only:
    - branches
  cache:
    key: sonarqube
    paths:
      - /root/.sonar/cache
  dependencies:
    - test # Retrieves coverage reports.
# SonarQube GitLab integration.
sonarqube:preview:
  <<: *sonarqube-job
  except:
    - master
    - dmz
  script: >
    sonar-scanner
    -D sonar.analysis.mode=preview
    -D sonar.host.url=$SONAR_HOST
    -D sonar.projectKey=$SONAR_PROJECT_KEY
    -D sonar.branch=$CI_COMMIT_REF_NAME
    -D sonar.login=$SONAR_TOKEN
    -D sonar.gitlab.project_id=$CI_PROJECT_PATH
    -D sonar.gitlab.commit_sha=$CI_COMMIT_SHA
    -D sonar.gitlab.ref_name=$CI_COMMIT_REF_NAME
# SonarQube analysis.
sonarqube:
  <<: *sonarqube-job
  except:
    - dmz
  script: >
    sonar-scanner
    -D sonar.host.url=$SONAR_HOST
    -D sonar.projectKey=$SONAR_PROJECT_KEY
    -D sonar.branch=$CI_COMMIT_REF_NAME
    -D sonar.login=$SONAR_TOKEN

# Code Climate
##############
# Coverage reporting to Code Climate.
#codeclimate:
#  image: node:6
#  stage: review
#  only:
#    - branches
#  except:
#    - dmz
#  dependencies:
#    - test
#  before_script:
#    - npm install -g codeclimate-test-reporter
#  script: codeclimate-test-reporter < coverage/lcov.info

####################
# PACK
####################

pack:
  image: snappinbox/electron-builder-wine # Wine is used to build Windows packages.
  allow_failure: true
  stage: pack
  only:
    - tags
  dependencies:
    - build:node-6
  artifacts: # Exports packages.
    name: "${CI_BUILD_REF_NAME}-${CI_BUILD_NAME}"
    paths:
      - packages/
  script: wine npm run pack
